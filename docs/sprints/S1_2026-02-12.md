# Sprint 1 – Fundação Backend + Typing Clean

> **Data:** 2026-02-12
> **Branch:** `wip/antigravity-fixes`
> **Status:** ✅ CONCLUÍDO

---

## Objetivo

Entregar o backend funcional com infraestrutura Docker, 5 tasks Celery com
endpoints REST, tipagem limpa (Pyright 0 errors) e evidência versionada.

---

## Backlog

### 1. Infraestrutura Docker Compose
- [x] Postgres 16 + seed (tenants, tax_rules)
- [x] Redis 7 (broker Celery)
- [x] MinIO (S3-compatible)
- [x] API (uvicorn + FastAPI)
- [x] Worker (Celery)
- [x] Beat (Celery Beat scheduler)

### 2. Backend Core
- [x] `config.py` – Settings via pydantic-settings
- [x] `database.py` – SQLAlchemy SessionLocal + get_db
- [x] `celery_app.py` – Celery app com Redis broker
- [x] `schema.sql` – tenants, tax_rules, audit_log, jobs, simulations, reconciliation_runs

### 3. Tools
- [x] `postgres_tool.py` – get_tax_rules, insert_audit_log (CAST-based UUID)
- [x] `s3_tool.py` – upload/download MinIO
- [x] `hubspot_tool.py` – upsert_company, upsert_deal, log_note (feature-gated)
- [x] `erp_connector_tool.py` – import CSV invoices + NF-e XML
- [x] `validation_tool.py` – payload validation, tolerance, rule consistency

### 4. Tasks Celery (A–E)
- [x] **Task A** – Validar CBS/IBS + audit_log → `POST /api/v1/tasks/validate`
- [x] **Task B** – Relatório conformidade → MinIO → `POST /api/v1/tasks/report`
- [x] **Task C** – Simulação what-if → persist → `POST /api/v1/tasks/simulate`
- [x] **Task D** – Reconciliação CSV → exceções → `POST /api/v1/tasks/reconcile`
- [x] **Task E** – HubSpot sync → readiness score → `POST /api/v1/tasks/hubspot-sync`

### 5. Routers auxiliares
- [x] `routers/tasks.py` – 5 endpoints sync/async
- [x] `routers/jobs.py` – CRUD de jobs
- [x] `routers/audit.py` – Listar/criar audit logs

### 6. Typing & Qualidade
- [x] Pyright config (`pyrightconfig.json`)
- [x] venv local (`backend/.venv`) com requirements.txt
- [x] Eliminar `**kwargs` unpacking em tasks router (32 erros)
- [x] Fix `Decimal | Literal[0]` em erp_connector_tool (1 erro)
- [x] Fix composite key typing em validation_tool (3 erros)
- [x] **Pyright: 0 errors, 0 warnings, 0 informations** ✅

---

## Bugs corrigidos

| # | Bug | Arquivo | Fix |
|---|-----|---------|-----|
| 1 | `::uuid` / `::jsonb` conflita com SQLAlchemy `text()` | 6 arquivos | `CAST(:param AS type)` |
| 2 | `Decimal(str(None))` quando scenario override é None | `task_c_simulation.py` | Null-coalescing explícito |
| 3 | `sum()` retorna `Literal[0]` quando lista vazia | `erp_connector_tool.py` | `Decimal("0")` como start |
| 4 | Dict com key tuple declarado como `dict[str, ...]` | `validation_tool.py` | `dict[tuple[str,str], Decimal]` |

---

## Evidências versionadas

| Documento | Conteúdo |
|-----------|----------|
| `docs/antigravity_issues.md` | Inventário original dos 16 erros Pyre2 |
| `docs/pyright_issues.md` | Backlog dos 36 erros Pyright (antes do fix) |
| `docs/pyright_report.txt` | Relatório final: **0 errors** |
| `docs/pyre_check_after_config.txt` | Nota sobre Pyre CLI vs Windows |

---

## Definition of Done (DoD)

- [x] Docker Compose sobe sem erro (`docker compose up --build`)
- [x] 5 endpoints retornam 200 com payload correto
- [x] Pyright: 0 errors
- [x] Todas as evidências versionadas na branch
- [x] Commits atômicos com mensagens convencionais

---

## Próximos passos (Sprint 2)

- [ ] Frontend console (dashboard de tarefas)
- [ ] Autenticação JWT (python-jose + passlib)
- [ ] Alembic migrations (substituir schema.sql)
- [ ] Testes unitários (pytest)
- [ ] CI/CD pipeline
