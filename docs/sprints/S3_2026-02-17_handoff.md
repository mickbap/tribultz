# TRIBULTZ — Sprint 3 Chat MVP Handoff (2026-02-17)

## Scope (MVP strict)

### In scope
- `POST /api/v1/chat/message` with JWT required and tenant scoping from JWT.
- Postgres persistence for:
  - `conversations(id, tenant_id, user_id, created_at, updated_at)`
  - `chat_messages(id, conversation_id, tenant_id, user_id, role, content, created_at)`
- Intent classifier MVP for `validate` (keywords/regex), fallback `unknown`.
- For `validate` intent:
  - Trigger Task A executor for CBS/IBS validation.
  - Return `response_markdown` + typed evidence (`job_id`, internal job link `/jobs/<id>`).
- Rate limiting:
  - Prefer Redis.
  - Fallback to in-memory (per-process) when Redis unavailable.
  - Return HTTP 429 when exceeded.
- Minimal observability:
  - Audit actions: `chat_message_received`, `chat_intent_classified`, `chat_task_triggered`.
  - Structured logs with `request_id/correlation_id`, `tenant_id`, `user_id`, `conversation_id`.
- Frontend `/chat`:
  - Send message, render markdown, render evidence cards/links.
  - Minimal UX (`disabled` during send + visible error).
- Backend tests:
  - Validate happy path (mock executor/crew).
  - Unauthorized 401.
  - Tenant isolation on `conversation_id` from another tenant -> 404.
  - Payload > 4k -> 422.
  - Rate limit exceeded -> 429.

### Out of scope
- Additional intents beyond `validate` (e.g. `audit/search`) and extra evidence types.
- Full conversation history loading by `conversation_id` in frontend.
- LLM-based intent intelligence (keep keyword/regex in MVP).
- SSO/MFA/login improvements (Sprint 4).
- Advanced observability dashboards/tracing.

## Current architecture target

### Backend
- `app/routers/chat.py`
  - `POST /api/v1/chat/message`
  - Request validation (`message` 1..4000, optional `conversation_id: UUID`)
  - Tenant from `current_user` JWT context
  - Guard for missing tenant -> 401
  - Calls `ChatService.handle_message(...)`
  - Returns `ChatMessageResponse` with typed evidence (`job`)
- `app/services/chat_service.py`
  - `classify_intent(message)` via keywords/regex
  - `handle_message(...)` to create/validate conversation, persist user/assistant messages, orchestrate execution, update timestamps
  - Tenant mismatch on conversation lookup -> 404
  - Integrates rate limiter
- `app/services/rate_limit.py`
  - `RateLimiter.check_or_raise(key)`
  - Redis first; in-memory fallback
  - Type narrowing guard before `incr` / `expire`
- `app/crews/executor.py`
  - `trigger_task_a(tenant_id, user_id, message) -> job_id`
  - `get_job_status(...)` if needed
- `app/schemas/chat.py`
  - Shared pydantic models: `JobEvidence`, `ChatMessageResponse`

### DB
- Alembic migration: `2026_02_16_0002_chat_history.py` with `conversations` and `chat_messages`.

### Frontend
- `frontend/src/app/chat/page.tsx`
  - Chat UI and minimal components (`MessageBubble`, `EvidenceCard`, `SimpleMarkdown`)
- `frontend/src/lib/api.ts`
  - `postChatMessage()`
  - strict `JobEvidence` typing

### CrewAI
- `crews/tribultz_chatops/`
  - `config/agents.yaml`, `config/tasks.yaml`
  - `tools/TriggerTaskATool.py`, `tools/GetJobStatusTool.py`
  - `main.py --dry-run`

## Blockers and priorities

### Blockers
- **B1**: Pyright Optional member access in rate limiter (`self.redis` Optional)
  - Owner: Backend
  - Fix: local narrowing (`r = self.redis; if r is None: ...`)
- **B2**: Pyright `Column[UUID]` mismatch crossing ORM/API boundaries
  - Owner: Backend
  - Fix: use schema/DTO UUID types at API/service boundary or explicit casts/guards

### High
- **H1**: Crew folder mount/path in API container may not include `./crews`
  - Owner: Backend/Infra
  - Fix: mount `./crews` in compose or move crew package to backend path

### Medium
- **M1**: Local vs Docker dependency drift (`pydantic[email]`, `email-validator`)
  - Owner: Backend/DevEx

### Low
- **L1**: Correlation ID propagation everywhere in logs/audits
  - Owner: Backend

## DoD status snapshot

### Confirmed at least once
- Chat migration applied successfully.
- Chat tests passed locally (venv) after email deps fix.
- Frontend `/chat` implemented with evidence cards and markdown.
- Frontend evidence typing tightened (`job_id` required).

### Remaining for official done
- Docker gate all green: `ruff + pyright + pytest -q`.
- Resolve `rate_limit` Optional typing and `Column[UUID]` type mismatch.
- Validate Crew path/mount behavior in container or explicitly scope to mock.
- Run minimal manual E2E (`login -> /chat -> validate -> job link`) with tenant correctness.
- Ensure tenant isolation (404) and rate-limit (429) tests execute in container.

## Source-of-truth execution

```bash
docker-compose -f infra/docker-compose.yml run --rm api sh -lc "pip install -q ruff pyright; ruff check app tests; pyright; pytest -q"
```

## Immediate next actions
1. Fix `rate_limit.py` with explicit Optional narrowing for Redis client.
2. Resolve ORM/API UUID boundary issues (`Column[UUID]` -> `uuid.UUID`).
3. Re-run Docker gate and archive outputs.
4. Execute manual E2E sanity path for tenant-scoped validate flow.

## Checklist controlado (Trae) — runbook + latest execution notes

> Objective: confirm backend gate, frontend build reproducibility, executor mode, and E2E steps.

### Linux equivalent command bundle

```bash
set -euo pipefail

echo "[A] BACKEND GATE (source of truth - Docker)"
docker compose -f infra/docker-compose.yml run --rm -T api sh -lc "set -euxo pipefail; pip install -q ruff pyright; ruff check app tests; pyright; pytest -q"

echo "[B] EXTRACTOR: endpoint executor/crew wiring"
docker compose -f infra/docker-compose.yml run --rm -T api sh -lc "python - <<'PY'\nimport inspect\nfrom app.routers import chat as chat_router\nfrom app.services.chat_service import ChatService\nprint('chat router file:', inspect.getfile(chat_router))\nprint('chat service file:', inspect.getfile(ChatService))\ntry:\n    import app.crews.executor as ex\n    print('executor module file:', inspect.getfile(ex))\n    src = open(inspect.getfile(ex), 'r', encoding='utf-8').read()\n    for needle in ['dry-run','dry_run','DRY_RUN','mock','Mock','kickoff','Crew','crews/tribultz_chatops','tribultz_chatops']:\n        if needle in src:\n            print('executor contains:', needle)\nexcept Exception as e:\n    print('executor import failed:', repr(e))\nPY"

echo "[C] FRONTEND BUILD (reproducible)"
cd frontend
node -v
npm -v
npm ci
npm run build

echo "[D] MANUAL E2E instructions"
echo "1) Login no Console"
echo "2) Abrir /chat"
echo "3) Enviar: Validate invoice INV-999 base 100.00 CBS 0 IBS 0"
echo "4) Ver resposta + evidence card com /jobs/<id>"
echo "5) Abrir Jobs/Audit e confirmar tenant correto"
```

### Latest execution notes in this environment
- [A] Could not run here: neither `docker-compose` nor `docker` binary exists in the current container shell.
- [B] Local import probe (without Docker) indicates chat backend modules are absent in this checkout:
  - `backend.app.routers.chat`: import failed
  - `backend.app.services.chat_service`: module not found
  - `backend.app.crews.executor`: module not found
- [C] Frontend build could not be completed in this environment due `npm ci` hanging (network/proxy warning context); should be rerun in project CI/Trae host.
- [D] E2E steps remain exactly as listed above and are ready once [A] and [C] pass in the target environment.
